(()=>{"use strict";window.util={advertsData:[],checked:{},SIMILAR_ADVERTS_COUNT:5,adForm:document.querySelector(".ad-form"),map:document.querySelector(".map"),mapPins:document.querySelector(".map__pins"),mainPin:document.querySelector(".map__pin--main"),mapFilters:document.querySelector(".map__filters"),activatedPage:!1,MapLimits:{MAP_END_X:1200,MAP_START_Y:130,MAP_END_Y:630},isEscEvent(e,t,o){27===e.keyCode&&(e.preventDefault(),t(o))},isEnterEvent(e,t){13===e.keyCode&&t()},addDisabled(e){e.forEach((e=>{e.setAttribute("disabled",!0)}))},removeElem(e){e.parentElement.removeChild(e)}},(()=>{const e=(e,t)=>{const o=new XMLHttpRequest;return o.responseType="json",o.timeout=1e4,o.addEventListener("load",(function(){200===o.status?(window.util.advertsData=o.response,e(window.util.advertsData)):t("Статус ответа: "+o.status+" "+o.statusText)})),o.addEventListener("error",(function(){t("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+o.timeout+"мс")})),o};window.backend={load:(t,o)=>{const i=e(t,o);i.open("GET","https://21.javascript.pages.academy/keksobooking/data"),i.send()},save:(t,o,i)=>{const n=e(o,i);n.open("POST","https://21.javascript.pages.academy/keksobooking"),n.send(t)}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.advert={render:t=>{if(t.offer){let o=e.cloneNode(!0),i=o.querySelector("img"),n=t.location.x-25,r=t.location.y-70;return o.style.left=n+"px",o.style.top=r+"px",i.src=t.author.avatar,i.alt=t.offer.title,o}return!1}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".popup");let t;const o=e=>{e.style.display="none"};window.card={render:i=>{let n=e.cloneNode(!0),r=n.querySelector(".popup__title"),d=n.querySelector(".popup__text--address"),a=n.querySelector(".popup__text--price"),l=n.querySelector(".popup__text--capacity"),c=n.querySelector(".popup__text--time"),s=n.querySelector(".popup__features"),u=n.querySelector(".popup__description"),w=n.querySelector(".popup__avatar"),p=n.querySelector(".popup__type"),m=n.querySelector(".popup__photos");if((e=>{switch(e){case"palace":t="Дворец";break;case"flat":t="Квартира";break;case"house":t="Дом";break;case"bungalow":t="Бунгало"}})(i.offer.type),i.offer.title?r.innerHTML=i.offer.title:o(r),i.offer.address?d.innerHTML=i.offer.address:o(d),i.offer.price?a.innerHTML=i.offer.price+"₽/ночь":o(a),i.offer.rooms&&i.offer.guests?l.innerHTML=`${i.offer.rooms} комнаты для ${i.offer.guests} гостей`:o(l),i.offer.checkin&&i.offer.checkout?c.innerHTML=`Заезд после ${i.offer.checkin}, выезд&nbsp;до ${i.offer.checkout}`:o(c),i.offer.features?s.innerHTML=i.offer.features.map((e=>" "+e)):o(s),i.offer.description?u.innerHTML=i.offer.description:o(u),i.author.avatar?w.src=i.author.avatar:o(w),i.offer.type?p.innerHTML=t:o(p),i.offer.photos)for(let e=0;e<i.offer.photos.length;e++)m.insertAdjacentHTML("beforeend",`<img src="${i.offer.photos[e]}" class="popup__photo" width="45" height="40" alt="Фотография жилья">`);else o(m);return n}}})(),(()=>{const e=window.util.map.querySelector(".map__filters-container");let t;const o=e=>{e.classList.add(".map__pin--active")},i=()=>(t=window.util.map.querySelector(".map__card"),t),n=()=>{i(),t&&window.util.removeElem(t),document.removeEventListener("keydown",r)},r=function(e){window.util.isEscEvent(e,n)},d=(o,d)=>{o.forEach((o=>{o.offer.title===d&&(n(),window.util.map.insertBefore(window.card.render(o),e),document.addEventListener("keydown",r),i(),t&&t.querySelector(".popup__close").addEventListener("click",(()=>{n()})))}))};window.util.mapPins.addEventListener("click",(function(e){const t=e.target;let i;t.matches(".map__pin")&&!t.matches(".map__pin--main")?(i=t.querySelector("img").alt,o(t),d(window.util.advertsData,i)):t.matches(".map__pin img")&&!t.parentElement.matches(".map__pin--main")&&(i=t.alt,o(t.parentElement),d(window.util.advertsData,i)),(()=>{const e=window.util.mapPins.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")})()})),window.map={closeCard:n}})(),(()=>{const e=["gif","jpg","jpeg","png"],t="img/muffin-grey.svg",o=window.util.adForm.querySelector("#avatar"),i=window.util.adForm.querySelector("#images"),n=window.util.adForm.querySelector(".ad-form-header__preview img"),r=window.util.adForm.querySelector(".ad-form__photo"),d=function(t){const i=t.target,d=i.files[0];let a,l=d.name.toLowerCase();if(i===o?a=n:(a=document.createElement("img"),a.height=70,a.width=70,r.appendChild(a)),e.some((e=>l.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(function(){a.src=e.result})),e.readAsDataURL(d)}};o.addEventListener("change",d),i.addEventListener("change",d),window.photo={clear:function(){let e=r.querySelector("img");n.src!==t&&(n.src=t),e&&window.util.removeElem(e)}}})(),(()=>{const e=Array.from(window.util.adForm.querySelectorAll(".ad-form__element")),t=Array.from(window.util.mapFilters.children);let o=[];const i=e=>{const o=document.createDocumentFragment();r(t);for(let t=0;t<window.util.SIMILAR_ADVERTS_COUNT;t++)o.appendChild(window.advert.render(e[t]));window.util.mapPins.appendChild(o)},n=e=>{const t=document.createElement("div");t.style="position: absolute; z-index: 1; width: 400px; font-size: 30px; text-align: center; left: 50%; top: 200px; margin-left: -200px; padding: 30px; background-color: rgba(0, 0, 0, 0.7); color: #ffffff;",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},r=e=>{e.forEach((e=>{e.removeAttribute("disabled")}))},d=()=>{window.util.addDisabled(e),window.util.addDisabled(t)},a=()=>{o=window.util.mapPins.querySelectorAll(".map__pin:not(.map__pin--main)"),o&&o.forEach((e=>{window.util.mapPins.removeChild(e)}))};d(),window.page={activate:()=>{window.util.activatedPage=!0,window.util.map.classList.remove("map--faded"),window.util.adForm.classList.remove("ad-form--disabled"),r(e),window.backend.load(i,n)},disable:()=>{window.util.activatedPage=!1,window.util.mapFilters.reset(),window.util.map.classList.add("map--faded"),window.util.adForm.classList.add("ad-form--disabled"),d(),window.util.mainPin.style.left="570px",window.util.mainPin.style.top="375px",window.drag.setAddressToField(),window.map.closeCard(),a(),window.filter.update(),window.photo.clear()},removeAllPins:a}})(),(()=>{const e=window.util.adForm.querySelector("#address"),t=32.5,o=window.util.MapLimits.MAP_START_Y-85,i=window.util.MapLimits.MAP_END_Y-85,n=()=>{let o,i=+window.util.mainPin.style.left.slice(0,-2),n=+window.util.mainPin.style.top.slice(0,-2),r=(i+t).toFixed();o=window.util.activatedPage?(n+85).toFixed():(n+32.5).toFixed(),e.value=`${r}, ${o}`};n(),window.util.mainPin.addEventListener("keydown",(function(e){window.util.isEnterEvent(e,window.page.activate)})),window.util.mainPin.addEventListener("mousedown",(function(e){if(0===e.button){let r={x:e.clientX,y:e.clientY};const d=function(e){e.preventDefault();const d=r.x-e.clientX,a=r.y-e.clientY;r={x:e.clientX,y:e.clientY};let l=window.util.mainPin.offsetTop-a,c=window.util.mainPin.offsetLeft-d;l<=o&&(window.util.mainPin.style.top=o+"px"),l>=i&&(window.util.mainPin.style.top=i+"px"),c<=-32.5&&(window.util.mainPin.style.left="-32.5px"),c>=window.util.MapLimits.MAP_END_X-t&&(window.util.mainPin.style.left=window.util.MapLimits.MAP_END_X-t+"px"),window.util.mainPin.style.top=window.util.mainPin.offsetTop-a+"px",window.util.mainPin.style.left=window.util.mainPin.offsetLeft-d+"px",n()},a=()=>{window.util.activatedPage||window.page.activate(),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",a),n()};document.addEventListener("mousemove",d),document.addEventListener("mouseup",a)}})),window.drag={setAddressToField:n}})(),(()=>{const e=window.util.adForm.querySelector("#type"),t=window.util.adForm.querySelector("#price"),o=window.util.adForm.querySelector("#timein"),i=window.util.adForm.querySelector("#timeout"),n=window.util.adForm.querySelector("#room_number"),r=window.util.adForm.querySelector("#capacity"),d=Array.from(r.options),a=document.querySelector("#success").content.querySelector(".success"),l=document.querySelector("#error").content.querySelector(".error"),c=document.querySelector("main"),s=window.util.adForm.querySelector(".ad-form__reset"),u={1:[1],2:[1,2],3:[1,2,3],100:[0]},w={BUNGALOW:0,FLAT:1e3,HOUSE:5e3,PALACE:1e4};d.forEach((e=>{e.selected||(e.disabled="true")})),n.addEventListener("input",(()=>{window.util.addDisabled(d),u[+n.value].forEach((e=>{r.querySelector(`option[value='${e}']`).removeAttribute("disabled")})),"100"===n.value?r.querySelector(`option[value='${u[100]}']`).selected=!0:r.querySelector(`option[value='${n.value}']`).selected=!0}));const p=function(e){const t=e.target;let n,r=t.value;n=t===o?i:o,n.value=r};e.addEventListener("change",(()=>{let o=e.value.toUpperCase();t.min=w[o],t.placeholder="от "+w[o]})),o.addEventListener("change",p),i.addEventListener("change",p);const m=e=>{const t=e.cloneNode(!0);c.insertAdjacentElement("beforeend",t)},f=()=>c.querySelector(".success"),v=()=>c.querySelector(".error"),y=e=>{const t=e();window.util.removeElem(t)},_=()=>{y(f),document.removeEventListener("keydown",E)},h=()=>{y(v),document.removeEventListener("keydown",S)},E=function(e){window.util.isEscEvent(e,y,f),document.removeEventListener("keydown",E)},S=function(e){window.util.isEscEvent(e,y,v),document.removeEventListener("keydown",S)},g=()=>{m(a),document.addEventListener("keydown",E),f().addEventListener("click",_),window.page.disable(),window.util.adForm.reset()},L=()=>{m(l),document.addEventListener("keydown",S),v().addEventListener("click",h);const e=v().querySelector("#error__button");e&&e.addEventListener("click",h)};window.util.adForm.addEventListener("submit",(function(e){window.backend.save(new FormData(window.util.adForm),g,L),e.preventDefault()})),s.addEventListener("click",(()=>{window.page.disable()}))})(),(()=>{const e={LOW:{MIN:0,MAX:1e4},MIDDLE:{MIN:1e4,MAX:5e4},HIGH:{MIN:5e4,MAX:1/0}};let t=[];const o=e=>{let t,o,i=e.name;"input"===e.tagName.toLowerCase()?(t=i,o=window.util.mapFilters.querySelectorAll(`input[name=${i}]:checked`),window.util.checked[t]=o?Array.from(o).map((e=>e.value)):[]):(t=i.slice(8),o=window.util.mapFilters.querySelector(`select[name=${i}]`),window.util.checked[t]=o.value)},i=()=>{const e=window.util.mapFilters.querySelector("#housing-type"),t=window.util.mapFilters.querySelector("#housing-rooms"),i=window.util.mapFilters.querySelector("#housing-guests"),n=window.util.mapFilters.querySelector("#housing-price"),r=window.util.mapFilters.querySelector(".map__checkbox");o(e),o(t),o(i),o(n),o(r)},n=(e,t)=>"any"===e||e===t.toString();i(),window.util.mapFilters.addEventListener("change",window.debounce((function(i){const r=document.createDocumentFragment();window.map.closeCard(),window.page.removeAllPins(),o(i.target),t=window.util.advertsData.filter((t=>{let o=n(window.util.checked.type,t.offer.type),i=n(window.util.checked.rooms,t.offer.rooms),r=n(window.util.checked.guests,t.offer.guests),d="any"===window.util.checked.price||(a=t.offer.price,e[window.util.checked.price.toUpperCase()].MIN<=a&&a<=e[window.util.checked.price.toUpperCase()].MAX);var a;let l=(e=>!!e&&(0===window.util.checked.features.length||window.util.checked.features.every((t=>e.includes(t)))))(t.offer.features);return!!(o&&d&&i&&r&&l)}));let d=t.length>window.util.SIMILAR_ADVERTS_COUNT?window.util.SIMILAR_ADVERTS_COUNT:t.length;for(let e=0;e<d;e++)r.appendChild(window.advert.render(t[e]));return window.util.mapPins.appendChild(r),t}))),window.filter={update:i}})()})();